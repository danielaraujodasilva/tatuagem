<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Misturador de Cores â€“ Presets</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body { background:#0f0f0f; color:#fff; }
    .card { background:#1c1c1c; border:none; }
    .color-sample { width:100%; height:50px; border-radius:6px; border:1px solid #333; -webkit-print-color-adjust: exact; print-color-adjust: exact; }

    /* PRINT */
    @media print {
      body { background:#fff !important; color:#000 !important; }
      .no-print { display:none !important; }
      table { width:100%; border-collapse:collapse; }
      th, td { border:1px solid #000; padding:6px; text-align:center; }
      .color-sample {
        border:1px solid #000 !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
        background-clip: padding-box !important;
      }
    }
      .no-print { display:none !important; }
      table { width:100%; border-collapse:collapse; }
      th, td { border:1px solid #000; padding:6px; text-align:center; }
      .color-sample { border:1px solid #000; }
    }
  </style>
</head>
<body class="container py-4">

<h2 class="mb-4">ðŸŽ¨ Presets de Mistura de Tinta</h2>

<div class="card p-3 mb-4 no-print">
  <label class="form-label">Carregar imagem para pinÃ§ar cor</label>
  <input type="file" id="imageInput" class="form-control" accept="image/*">
  <canvas id="canvas" class="w-100 mt-3 rounded" style="cursor:crosshair"></canvas>

  <div class="row mt-3">
    <div class="col-md-4">
      <label class="form-label">Batoque</label>
      <select id="batoque" class="form-select">
        <option value="P">P (20 gotas)</option>
        <option value="M">M (40 gotas)</option>
        <option value="G">G (80 gotas)</option>
        <option value="GG">GG (160 gotas)</option>
      </select>
    </div>
    <div class="col-md-8 d-flex align-items-end">
      <button class="btn btn-danger w-100" onclick="savePreset()">Salvar cor pinÃ§ada</button>
    </div>
  </div>
</div>

<div class="d-flex justify-content-between align-items-center mb-2">
  <h4>ðŸ“‹ Tabela de Misturas</h4>
  <div class="no-print">
    <button class="btn btn-outline-light me-2" onclick="window.print()">Imprimir tabela</button>
    <button class="btn btn-outline-danger" onclick="clearPresets()">Limpar tudo</button>
  </div>
</div>

<table class="table table-dark table-striped align-middle">
  <thead>
    <tr>
      <th>Cor</th>
      <th>Vermelho</th>
      <th>Verde</th>
      <th>Azul</th>
      <th>Branco</th>
      <th>Preto</th>
      <th class="no-print">AÃ§Ãµes</th>
    </tr>
  </thead>
  <tbody id="presetTable"></tbody>
</table>

<script>
const DROP_PER_ML = 40;
const BATOQUES = { P:20, M:40, G:80, GG:160 };
let presets = JSON.parse(localStorage.getItem('presets') || '[]');
let lastPicked = null;

const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

imageInput.addEventListener('change', e => {
  const img = new Image();
  img.onload = () => {
    canvas.width = img.width;
    canvas.height = img.height;
    ctx.drawImage(img,0,0);
  };
  img.src = URL.createObjectURL(e.target.files[0]);
});

canvas.addEventListener('click', e => {
  const rect = canvas.getBoundingClientRect();
  const x = ((e.clientX - rect.left) / rect.width) * canvas.width;
  const y = ((e.clientY - rect.top) / rect.height) * canvas.height;
  const d = ctx.getImageData(x,y,1,1).data;

  const r=d[0], g=d[1], b=d[2];
  const min=Math.min(r,g,b);
  const max=Math.max(r,g,b);

  const white=min;
  const black=255-max;

  const rr=r-white;
  const gg=g-white;
  const bb=b-white;

  const total=rr+gg+bb+white+black || 1;

  lastPicked={
    color:`rgb(${r},${g},${b})`,
    mix:{
      r:rr/total,
      g:gg/total,
      b:bb/total,
      w:white/total,
      k:black/total
    }
  };
});

function savePreset(){
  if(!lastPicked) return;
  const drops=BATOQUES[batoque.value];
  const m=lastPicked.mix;

  presets.push({
    color:lastPicked.color,
    r:Math.round(m.r*drops),
    g:Math.round(m.g*drops),
    b:Math.round(m.b*drops),
    w:Math.round(m.w*drops),
    k:Math.round(m.k*drops)
  });

  localStorage.setItem('presets',JSON.stringify(presets));
  render();
}

function render(){
  presetTable.innerHTML='';
  presets.forEach((p,i)=>{
    presetTable.innerHTML+=`
      <tr>
        <td><div class="color-sample" style="background:${p.color}"></div></td>
        <td>${p.r}</td>
        <td>${p.g}</td>
        <td>${p.b}</td>
        <td>${p.w}</td>
        <td>${p.k}</td>
        <td class="no-print"><button class="btn btn-sm btn-danger" onclick="removePreset(${i})">X</button></td>
      </tr>`;
  });
}

function removePreset(i){ presets.splice(i,1); localStorage.setItem('presets',JSON.stringify(presets)); render(); }
function clearPresets(){ if(confirm('Limpar tudo?')){ presets=[]; localStorage.removeItem('presets'); render(); } }

render();
</script>

</body>
</html>
