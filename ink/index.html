<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Misturador de Cores – Pinça & Presets</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <meta name="theme-color" content="#000000">

  <style>
    body {
      background: radial-gradient(circle at top, #1a1a1a, #000);
      color: #fff;
      min-height: 100vh;
    }
    .app-card {
      background: #121212;
      border-radius: 18px;
      box-shadow: 0 0 40px rgba(0,0,0,.7);
      animation: fadeIn .5s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    canvas {
      width: 100%;
      max-height: 340px;
      border-radius: 14px;
      cursor: crosshair;
      background: #000;
      transition: transform .2s ease, box-shadow .2s ease;
    }
    canvas:hover {
      transform: scale(1.015);
      box-shadow: 0 0 20px rgba(255,0,0,.15);
    }
    .preset-card {
      background: linear-gradient(180deg, #1a1a1a, #111);
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.6);
      animation: fadeIn .4s ease;
      transition: transform .2s ease;
    }
    .preset-card:hover {
      transform: translateY(-6px);
    }
    .color-preview {
      height: 80px;
      border-radius: 12px;
      box-shadow: inset 0 0 15px rgba(0,0,0,.6);
    }
    .badge-color {
      background: #000;
      font-size: .75rem;
    }
    .btn-danger {
      background: linear-gradient(135deg, #b30000, #ff1a1a);
      border: none;
    }
    .btn-danger:hover { opacity: .9; }
    @media print {
      body { background: #fff; color: #000; }
      .no-print { display: none; }
      .preset-card { break-inside: avoid; border: 1px solid #000; box-shadow:none; }
    }
  </style>
</head>
<body>

<div class="container py-4">

  <h1 class="fw-bold text-center mb-4">Misturador de Cores – Pinça & Presets</h1>

  <div class="row g-4">

    <!-- CONTROLES -->
    <div class="col-lg-5">
      <div class="app-card p-4">

        <div class="mb-3">
          <label class="form-label">Imagem de referência</label>
          <input type="file" class="form-control" id="imageInput" accept="image/*">
        </div>

        <canvas id="canvas" class="mb-3"></canvas>

        <div id="pickedInfo" class="fw-bold text-center mb-3"></div>

        <div class="mb-3">
          <label class="form-label">Batoque</label>
          <select id="batoque" class="form-select">
            <option value="P">P – 0,5 ml (~20 gotas)</option>
            <option value="M">M – 1 ml (~40 gotas)</option>
            <option value="G">G – 2 ml (~80 gotas)</option>
            <option value="GG">GG – 4 ml (~160 gotas)</option>
          </select>
        </div>

        <div class="d-flex gap-2 no-print">
          <button class="btn btn-danger w-100" onclick="window.print()">Imprimir</button>
          <button class="btn btn-outline-light w-100" onclick="clearPresets()">Limpar tudo</button>
        </div>

      </div>
    </div>

    <!-- PRESETS -->
    <div class="col-lg-7">
      <div class="row g-3" id="presetList"></div>
    </div>

  </div>
</div>

<script>
// === CONFIGURAÇÃO CALIBRADA NA PRÁTICA ===
// Teste real: 0,5ml = 20 gotas
// Logo: 1ml = 40 gotas
const dropsPerMl = 40;

const cupVolumes = {
  P: 0.5,
  M: 1,
  G: 2,
  GG: 4
};

let presets = JSON.parse(localStorage.getItem('presets') || '[]');

const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

function rgbToMix(r, g, b) {
  const total = r + g + b || 1;
  return {
    red: Math.round((r / total) * 100),
    yellow: Math.round((g / total) * 100),
    blue: Math.round((b / total) * 100)
  };
}

function renderPresets() {
  const list = document.getElementById('presetList');
  list.innerHTML = '';

  presets.forEach((p, i) => {
    list.innerHTML += `
      <div class="col-md-6">
        <div class="preset-card p-3 h-100">
          <div class="color-preview mb-2" style="background:${p.color}"></div>
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="badge badge-color">RGB ${p.rgb}</span>
            <span class="badge bg-secondary">${p.batoque}</span>
          </div>
          <small>
            Vermelho: ${p.mix.red}% – ${p.drops.red} gotas<br>
            Amarelo: ${p.mix.yellow}% – ${p.drops.yellow} gotas<br>
            Azul: ${p.mix.blue}% – ${p.drops.blue} gotas
          </small>
          <button class="btn btn-sm btn-outline-danger w-100 mt-3 no-print" onclick="removePreset(${i})">Excluir</button>
        </div>
      </div>`;
  });

  localStorage.setItem('presets', JSON.stringify(presets));
}

function removePreset(i) {
  presets.splice(i, 1);
  renderPresets();
}

function clearPresets() {
  presets = [];
  renderPresets();
}

imageInput.addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = ev => {
    const img = new Image();
    img.onload = () => {
      canvas.width = img.naturalWidth;
      canvas.height = img.naturalHeight;
      ctx.drawImage(img, 0, 0);
    };
    img.src = ev.target.result;
  };
  reader.readAsDataURL(file);
});

canvas.addEventListener('click', e => {
  const rect = canvas.getBoundingClientRect();
  const x = ((e.clientX - rect.left) / rect.width) * canvas.width;
  const y = ((e.clientY - rect.top) / rect.height) * canvas.height;
  const data = ctx.getImageData(x, y, 1, 1).data;

  const rgb = `rgb(${data[0]}, ${data[1]}, ${data[2]})`;
  const mix = rgbToMix(data[0], data[1], data[2]);

  const totalDrops = cupVolumes[batoque.value] * dropsPerMl;

  const drops = {
    red: Math.round(totalDrops * mix.red / 100),
    yellow: Math.round(totalDrops * mix.yellow / 100),
    blue: Math.round(totalDrops * mix.blue / 100)
  };

  presets.unshift({
    color: rgb,
    rgb: `${data[0]}, ${data[1]}, ${data[2]}`,
    mix,
    drops,
    batoque: batoque.value
  });

  pickedInfo.innerHTML = `Cor pinçada: <span style="display:inline-block;width:26px;height:26px;border-radius:50%;background:${rgb}"></span> ${rgb}`;

  renderPresets();
});

renderPresets();
</script>

</body>
</html>
