<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisador de Conversas WhatsApp</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; }
        h1 { color: #25D366; }
        #upload { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        button { padding: 10px 20px; background: #25D366; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 5px; }
        button:hover { background: #1da856; }
        #conversa { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; flex-direction: column; gap: 10px; min-height: 300px; }
        .mensagem { padding: 12px; border-radius: 12px; max-width: 80%; word-wrap: break-word; align-self: flex-start; }
        .direita { background: #c8e6c9; align-self: flex-end; }
        .esquerda { background: #e0f7fa; }
        .remetente { font-weight: bold; color: #25D366; margin-bottom: 4px; }
        .data { color: gray; font-size: 0.8em; margin-bottom: 8px; }
        .audio-container { margin-top: 10px; background: #f0f0f0; padding: 12px; border-radius: 8px; }
        .transcricao { margin-top: 10px; background: #e8f5e9; padding: 10px; border-radius: 6px; font-style: italic; }
        .imagem { margin-top: 10px; text-align: center; cursor: pointer; }
        .imagem img { max-width: 100%; max-height: 400px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        #status { margin: 20px 0; padding: 15px; background: #fff3e0; border-radius: 8px; white-space: pre-line; font-weight: bold; }
        audio { width: 100%; margin-top: 8px; }
        #progress-container { margin: 20px 0; display: none; }
        #progress-bar { height: 35px; width: 100%; background: #ddd; border-radius: 20px; overflow: hidden; }
        #progress-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #25D366, #128C7E); transition: width 0.4s ease; text-align: center; line-height: 35px; color: white; font-weight: bold; font-size: 1.1em; }
        #progress-text { margin-top: 10px; text-align: center; font-size: 1.2em; }
        #copiarBtn, #analiseBtn { background: #128C7E; margin-top: 20px; }
        .audio-progress { font-size: 0.9em; color: #555; margin-top: 5px; }
        #overlay { position: fixed; display: none; width: 100%; height: 100%; top: 0; left: 0; background: rgba(0,0,0,0.9); z-index: 10; justify-content: center; align-items: center; cursor: pointer; }
        #overlay img { max-width: 95%; max-height: 95%; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.8); }
        #analiseDiv { margin-top: 30px; padding: 20px; background: #f0f8ff; border-radius: 10px; border-left: 5px solid #25D366; white-space: pre-wrap; }
    </style>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- Carrega a key Groq de forma segura (antes do module) -->
    <script src="config.js"></script>
</head>
<body>
    <h1>Analisador de Conversas WhatsApp</h1>
    <p>Texto, imagens (clique para ampliar) e áudios com reprodução e transcrição!</p>
    <p><strong>Análise com IA gratuita (Groq - Llama 3 70B)</strong></p>
    <div id="upload">
        <input type="file" id="fileInput" accept=".zip">
        <button id="processButton">Processar Conversa</button>
    </div>

    <div id="progress-container">
        <div id="progress-bar"><div id="progress-fill">0%</div></div>
        <div id="progress-text">Iniciando...</div>
    </div>

    <div id="status"></div>
    <div id="conversa"></div>
    <button id="copiarBtn" style="display:none;">Copiar toda a conversa</button>
    <button id="analiseBtn" style="display:none;">Analisar com IA (Groq - Grátis)</button>
    <div id="analiseDiv"></div>

    <div id="overlay" onclick="this.style.display='none'">
        <img src="" alt="Imagem ampliada">
    </div>

    <script type="module">
        import { pipeline } from 'https://cdn.jsdelivr.net/npm/@huggingface/transformers@latest';

        const { createFFmpeg } = FFmpeg;
        const ffmpeg = createFFmpeg({ log: false });
        let whisperPipeline = null;

        const progressContainer = document.getElementById('progress-container');
        const progressFill = document.getElementById('progress-fill');
        const progressText = document.getElementById('progress-text');
        const statusDiv = document.getElementById('status');
        const conversaDiv = document.getElementById('conversa');
        const copiarBtn = document.getElementById('copiarBtn');
        const analiseBtn = document.getElementById('analiseBtn');
        const analiseDiv = document.getElementById('analiseDiv');
        const overlay = document.getElementById('overlay');
        const overlayImg = overlay.querySelector('img');

        function atualizarProgresso(percent, texto) {
            progressContainer.style.display = 'block';
            progressFill.style.width = `${percent}%`;
            progressFill.innerText = `${Math.round(percent)}%`;
            progressText.innerText = texto;
            if (percent >= 100) setTimeout(() => progressContainer.style.display = 'none', 3000);
        }

        async function carregarWhisper() {
            if (!whisperPipeline) {
                atualizarProgresso(0, 'Carregando modelo de transcrição...');
                whisperPipeline = await pipeline('automatic-speech-recognition', 'Xenova/whisper-small');
                atualizarProgresso(30, 'Modelo carregado!');
            }
        }

        async function carregarFFmpeg() {
            if (!ffmpeg.isLoaded()) {
                atualizarProgresso(30, 'Carregando conversor de áudio...');
                await ffmpeg.load();
                atualizarProgresso(50, 'Pronto para áudios!');
            }
        }

        document.getElementById('processButton').onclick = async () => {
            const file = document.getElementById('fileInput').files[0];
            if (!file) return alert('Selecione o ZIP da conversa.');

            conversaDiv.innerHTML = '';
            copiarBtn.style.display = 'none';
            analiseBtn.style.display = 'none';
            analiseDiv.innerHTML = '';
            atualizarProgresso(0, 'Extraindo ZIP...');

            const zip = new JSZip();
            await zip.loadAsync(file);
            atualizarProgresso(10, 'ZIP extraído.');

            let chatFile = null;
            for (const filename in zip.files) {
                if (filename.toLowerCase().endsWith('.txt') && !zip.files[filename].dir) {
                    chatFile = zip.files[filename];
                    break;
                }
            }
            if (!chatFile) return alert('Arquivo .txt não encontrado no ZIP.');

            const chatText = await chatFile.async('string');

            await carregarWhisper();
            await carregarFFmpeg();

            const audioFiles = Object.keys(zip.files).filter(f => f.toLowerCase().endsWith('.opus'));
            let audioIndex = 0;

            atualizarProgresso(50, 'Exibindo conversa...');

            const linhas = chatText.split(/\r?\n/);
            let mensagensExibidas = 0;
            let ultimaMsgDiv = null;

            for (let linha of linhas) {
                linha = linha.trim();
                if (!linha) continue;

                const match = linha.match(/^(\d{1,2}\/\d{1,2}\/\d{4} \d{1,2}:\d{2}) - (.*?): (.*)$/);

                if (match) {
                    const data = match[1];
                    const remetente = match[2].trim();
                    let mensagem = match[3].trim();

                    ultimaMsgDiv = document.createElement('div');
                    ultimaMsgDiv.className = `mensagem ${remetente.toLowerCase().includes('estúdio tattooage') || remetente.toLowerCase().includes('deise') ? 'direita' : 'esquerda'}`;
                    ultimaMsgDiv.innerHTML = `
                        <div class="data">${data}</div>
                        <div class="remetente">${remetente}:</div>
                        <div class="texto">${mensagem.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
                    `;
                    conversaDiv.appendChild(ultimaMsgDiv);
                    mensagensExibidas++;

                    // Áudio
                    if (mensagem.toLowerCase().includes('áudio') || mensagem.includes('omitido') || mensagem.includes('.opus') || mensagem.includes('PTT-')) {
                        if (audioIndex < audioFiles.length) {
                            const audioName = audioFiles[audioIndex++];
                            const audioFile = zip.files[audioName];

                            const container = document.createElement('div');
                            container.className = 'audio-container';
                            container.innerHTML = '<strong>Áudio:</strong> Convertendo...';
                            ultimaMsgDiv.appendChild(container);

                            const audioData = await audioFile.async('uint8array');
                            await processarAudio(audioData, container);
                        }
                    }

                    // Imagem anexada
                    const imgMatch = mensagem.match(/([-\w]+\.(jpg|jpeg|png|gif|webp|bmp))/i);
                    if (imgMatch) {
                        const baseName = imgMatch[1].replace(/\s/g, '').toLowerCase();
                        const possibleFiles = Object.keys(zip.files).filter(f => f.toLowerCase().includes(baseName));
                        if (possibleFiles.length > 0) {
                            const imgFile = zip.files[possibleFiles[0]];
                            const imgBlob = await imgFile.async('blob');
                            const imgUrl = URL.createObjectURL(imgBlob);

                            const imgContainer = document.createElement('div');
                            imgContainer.className = 'imagem';
                            imgContainer.innerHTML = `<img src="${imgUrl}" alt="Imagem anexada">`;
                            ultimaMsgDiv.appendChild(imgContainer);

                            imgContainer.onclick = () => {
                                overlayImg.src = imgUrl;
                                overlay.style.display = 'flex';
                            };
                        }
                    }
                } else if (ultimaMsgDiv && linha) {
                    const textoDiv = ultimaMsgDiv.querySelector('.texto');
                    if (textoDiv) {
                        textoDiv.innerHTML += '<br>' + linha.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    }
                }
            }

            atualizarProgresso(100, 'Concluído!');
            statusDiv.innerHTML = `<strong>${mensagensExibidas} mensagens exibidas!</strong>`;
            copiarBtn.style.display = 'block';
            analiseBtn.style.display = 'block';
        };

        analiseBtn.onclick = async () => {
            if (!window.GROQ_API_KEY || window.GROQ_API_KEY.trim() === '') {
                analiseDiv.innerHTML = '<strong style="color:red;">Erro: API Key da Groq não carregada. Verifique o config.js.</strong>';
                return;
            }

            let textoCompleto = '';
            conversaDiv.querySelectorAll('.mensagem').forEach(div => {
                const data = div.querySelector('.data')?.innerText || '';
                const remetente = div.querySelector('.remetente')?.innerText || '';
                const mensagem = div.querySelector('.texto')?.innerHTML.replace(/<br>/g, '\n') || '';
                const transcricao = div.querySelector('.transcricao') ? div.querySelector('.transcricao').innerText : '';
                textoCompleto += `${data} - ${remetente}: ${mensagem}\n${transcricao}\n\n`;
            });

            analiseDiv.innerHTML = '<strong>Analisando com IA gratuita (Groq - Llama 3 70B)...</strong>';

            try {
                const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.GROQ_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'llama3-70b-8192',
                        messages: [
                            { role: 'system', content: 'Você é um analista de vendas especializado em atendimento por WhatsApp. Analise a conversa, dê estatísticas numéricas (tempo de resposta, volume de mensagens, taxa de engajamento), pontos fortes, pontos de melhoria e sugestões práticas para aumentar conversões.' },
                            { role: 'user', content: textoCompleto }
                        ],
                        temperature: 0.7,
                        max_tokens: 1000
                    })
                });

                if (!response.ok) throw new Error('Erro na API Groq');

                const result = await response.json();
                const análise = result.choices[0].message.content.trim();

                analiseDiv.innerHTML = `<strong>Análise da IA (Groq):</strong><br><br>${análise.replace(/\n/g, '<br>')}`;
            } catch (error) {
                analiseDiv.innerHTML += '<br><strong style="color:red;">Erro ao conectar com a IA. Verifique sua key Groq.</strong>';
                console.error(error);
            }
        };

        copiarBtn.onclick = () => {
            let textoCompleto = '';
            conversaDiv.querySelectorAll('.mensagem').forEach(div => {
                const data = div.querySelector('.data')?.innerText || '';
                const remetente = div.querySelector('.remetente')?.innerText || '';
                const mensagem = div.querySelector('.texto')?.innerHTML.replace(/<br>/g, '\n') || '';
                const transcricao = div.querySelector('.transcricao') ? div.querySelector('.transcricao').innerText : '';
                textoCompleto += `${data} - ${remetente}: ${mensagem}\n${transcricao}\n\n`;
            });
            navigator.clipboard.writeText(textoCompleto);
            alert('Conversa copiada!');
        };

        async function processarAudio(audioData, container) {
            try {
                ffmpeg.FS('writeFile', 'input.opus', audioData);
                container.innerHTML = '<strong>Áudio:</strong> Convertendo para formato compatível...';

                await ffmpeg.run('-i', 'input.opus', '-ar', '16000', '-ac', '1', '-f', 'f32le', 'output.raw');

                const rawData = ffmpeg.FS('readFile', 'output.raw');
                const audioArray = new Float32Array(rawData.buffer);

                await ffmpeg.run('-i', 'input.opus', '-ar', '16000', '-ac', '1', 'output.wav');
                const wavData = ffmpeg.FS('readFile', 'output.wav');
                const wavBlob = new Blob([wavData.buffer], { type: 'audio/wav' });
                const wavUrl = URL.createObjectURL(wavBlob);

                const audioPlayer = document.createElement('audio');
                audioPlayer.controls = true;
                audioPlayer.src = wavUrl;

                container.innerHTML = '<strong>Áudio:</strong> Transcrevendo 0%...';
                const progressDiv = document.createElement('div');
                progressDiv.className = 'audio-progress';
                container.appendChild(progressDiv);

                let progress = 0;
                const interval = setInterval(() => {
                    progress += 15;
                    if (progress > 90) progress = 90;
                    progressDiv.innerText = `Transcrevendo ${progress}%...`;
                }, 600);

                const result = await whisperPipeline(audioArray, { language: 'portuguese' });
                clearInterval(interval);

                const transcricao = result.text.trim() || '(sem fala detectada)';

                container.innerHTML = `
                    <strong>Áudio:</strong><br>
                    ${audioPlayer.outerHTML}
                    <div class="transcricao"><strong>Transcrição:</strong> ${transcricao}</div>
                `;
            } catch (error) {
                container.innerHTML += '<br><em>Erro na transcrição.</em>';
                console.error(error);
            } finally {
                try { ffmpeg.FS('unlink', 'input.opus'); } catch(e) {}
                try { ffmpeg.FS('unlink', 'output.raw'); } catch(e) {}
                try { ffmpeg.FS('unlink', 'output.wav'); } catch(e) {}
            }
        }
    </script>
</body>
</html>