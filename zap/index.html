<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisador de Conversas WhatsApp - Com Progresso</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; }
        h1 { color: #25D366; }
        #upload { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        button { padding: 10px 20px; background: #25D366; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        button:hover { background: #1da856; }
        #conversa { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .mensagem { margin-bottom: 15px; padding: 10px; border-radius: 10px; max-width: 80%; display: inline-block; }
        .remetente { font-weight: bold; color: #25D366; }
        .data { color: gray; font-size: 0.8em; margin-bottom: 5px; }
        .texto { line-height: 1.5; word-wrap: break-word; }
        .audio-container { margin-top: 10px; background: #f0f0f0; padding: 10px; border-radius: 8px; }
        .transcricao { margin-top: 8px; font-style: italic; color: #333; background: #e8f5e9; padding: 8px; border-radius: 5px; }
        .esquerda { background: #e0f7fa; align-self: flex-start; }
        .direita { background: #c8e6c9; align-self: flex-end; margin-left: auto; }
        #status { margin: 20px 0; padding: 10px; background: #fff3e0; border-radius: 5px; white-space: pre-line; }
        audio { width: 100%; margin-top: 5px; }

        /* Barra de progresso */
        #progress-container { margin: 20px 0; }
        #progress-bar { height: 30px; width: 100%; background: #ddd; border-radius: 15px; overflow: hidden; box-shadow: inset 0 2px 5px rgba(0,0,0,0.2); }
        #progress-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #25D366, #128C7E); transition: width 0.4s ease, background 0.6s; text-align: center; line-height: 30px; color: white; font-weight: bold; }
        #progress-text { margin-top: 8px; text-align: center; font-size: 1.1em; }

        #conversa { display: flex; flex-direction: column; gap: 10px; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.10/dist/umd/ffmpeg.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2"></script>
</head>
<body>
    <h1>Analisador de Conversas WhatsApp - Alta Precisão + Progresso</h1>
    <p><strong>Modelo:</strong> Whisper Small → alta precisão em PT-BR</p>
    <div id="upload">
        <input type="file" id="fileInput" accept=".zip">
        <button onclick="processarArquivo()">Processar Conversa</button>
    </div>

    <div id="progress-container" style="display:none;">
        <div id="progress-bar"><div id="progress-fill">0%</div></div>
        <div id="progress-text">Iniciando...</div>
    </div>

    <div id="status"></div>
    <div id="conversa"></div>

    <script>
        const { createFFmpeg } = FFmpeg;
        const ffmpeg = createFFmpeg({ log: false });
        let pipeline = null;

        // Elementos de progresso
        const progressContainer = document.getElementById('progress-container');
        const progressFill = document.getElementById('progress-fill');
        const progressText = document.getElementById('progress-text');
        const statusDiv = document.getElementById('status');

        function atualizarProgresso(percent, texto) {
            progressContainer.style.display = 'block';
            progressFill.style.width = percent + '%';
            progressFill.innerText = Math.round(percent) + '%';
            progressText.innerText = texto;
            if (percent >= 100) {
                setTimeout(() => { progressContainer.style.display = 'none'; }, 2000);
            }
        }

        async function carregarModeloWhisper() {
            if (!pipeline) {
                atualizarProgresso(0, 'Carregando modelo Whisper Small (~500MB - primeira vez)...');
                pipeline = await Xenova.pipeline('automatic-speech-recognition', 'Xenova/whisper-small', {
                    progress_callback: (data) => {
                        if (data.status === 'downloading' || data.status === 'loading') {
                            const percent = (data.loaded / data.total) * 100 || 0;
                            atualizarProgresso(percent * 0.4, `Baixando modelo: ${data.file} (${Math.round(percent)}%)`);
                        } else if (data.status === 'ready') {
                            atualizarProgresso(40, 'Modelo Whisper carregado!');
                        }
                    }
                });
            }
        }

        async function carregarFFmpeg() {
            if (!ffmpeg.isLoaded()) {
                atualizarProgresso(40, 'Carregando FFmpeg.wasm...');
                // Manual fetch do wasm para progresso
                const wasmURL = 'https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.10/dist/umd/ffmpeg-core.wasm';
                const response = await fetch(wasmURL);
                const total = parseInt(response.headers.get('content-length') || '0');
                const reader = response.body.getReader();
                let loaded = 0;
                const chunks = [];
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    chunks.push(value);
                    loaded += value.byteLength;
                    const percent = total ? (loaded / total) * 20 + 40 : 50; // 20% do total
                    atualizarProgresso(percent, `Carregando FFmpeg (${Math.round((loaded/1024/1024).toFixed(1))}MB)`);
                }
                const wasmBinary = await new Blob(chunks).arrayBuffer();
                await ffmpeg.load({ wasmBinary });
                atualizarProgresso(60, 'FFmpeg carregado!');
            }
        }

        async function processarArquivo() {
            const file = document.getElementById('fileInput').files[0];
            if (!file) return alert('Selecione o arquivo ZIP exportado do WhatsApp.');

            atualizarProgresso(0, 'Extraindo ZIP...');
            statusDiv.innerText = '';

            const zip = new JSZip();
            await zip.loadAsync(file);
            atualizarProgresso(5, 'ZIP extraído.');

            // Encontra o .txt
            let chatFile = null;
            let chatFileName = null;
            for (const filename in zip.files) {
                if (filename.toLowerCase().endsWith('.txt') && !zip.files[filename].dir) {
                    chatFile = zip.file(filename);
                    chatFileName = filename;
                    break;
                }
            }
            if (!chatFile) return alert('Nenhum arquivo .txt encontrado no ZIP.');

            const chatText = await chatFile.async('string');

            // Carrega modelo e ffmpeg com progresso
            await carregarModeloWhisper();
            await carregarFFmpeg();

            // Conta áudios para progresso geral
            const audioFiles = [];
            for (const fn in zip.files) {
                if (fn.toLowerCase().endsWith('.opus')) {
                    audioFiles.push(fn);
                }
            }
            const totalAudios = audioFiles.length;
            let audiosProcessados = 0;

            document.getElementById('conversa').innerHTML = '';
            atualizarProgresso(60, `Processando conversa (${totalAudios} áudio${totalAudios === 1 ? '' : 's'} encontrado${totalAudios === 1 ? '' : 's'})...`);

            const linhas = chatText.split('\n');
            for (let linha of linhas) {
                const match = linha.match(/^(\d{1,2}\/\d{1,2}\/\d{2,4}, \d{1,2}:\d{2}(?::\d{2})?) - (.*?): (.*)$/);
                if (match) {
                    const data = match[1];
                    const remetente = match[2];
                    let mensagem = match[3].trim();

                    const msgDiv = document.createElement('div');
                    msgDiv.className = `mensagem ${remetente.toLowerCase().includes('você') || remetente.toLowerCase() === 'eu' ? 'direita' : 'esquerda'}`;
                    msgDiv.innerHTML = `<div class="data">${data}</div><div class="remetente">${remetente}:</div><div class="texto">${mensagem}</div>`;
                    document.getElementById('conversa').appendChild(msgDiv);

                    if (mensagem.includes('<áudio omitido>') || mensagem.includes('audio omitted') || mensagem.includes('.opus') || mensagem.includes('PTT-')) {
                        let audioName = null;
                        const opusMatch = mensagem.match(/(PTT-\d{8}-\w+\.opus|\w+\.opus)/i);
                        if (opusMatch) audioName = opusMatch[1];
                        else {
                            // Pega o próximo .opus disponível
                            audioName = audioFiles.find(fn => zip.file(fn));
                        }

                        if (audioName && zip.file(audioName)) {
                            const audioContainer = document.createElement('div');
                            audioContainer.className = 'audio-container';
                            audioContainer.innerHTML = '<strong>Áudio:</strong> Iniciando processamento...';
                            msgDiv.appendChild(audioContainer);

                            const audioData = await zip.file(audioName).async('uint8array');
                            await processarAudio(audioName, audioData, audioContainer, () => {
                                audiosProcessados++;
                                const percent = 60 + (audiosProcessados / totalAudios) * 40;
                                atualizarProgresso(percent, `Processando áudio ${audiosProcessados} de ${totalAudios}...`);
                            });
                            audioFiles.splice(audioFiles.indexOf(audioName), 1); // remove da lista
                        }
                    }
                }
            }

            atualizarProgresso(100, 'Concluído! Conversa totalmente analisada com transcrições.');
            statusDiv.innerText = 'Pronto! Agora você pode copiar o texto e colar aqui para analisarmos a performance da equipe de vendas juntos.';
        }

        async function processarAudio(fileName, audioData, container, onProgress) {
            const inputName = 'input.opus';
            const outputName = 'output.wav';

            // Progresso FFmpeg (transcode)
            ffmpeg.setProgress(({ ratio }) => {
                const percent = ratio >= 0 ? ratio : 0;
                container.innerHTML = `<strong>Áudio:</strong> Convertendo (${Math.round(percent * 100)}%)...`;
            });

            try {
                ffmpeg.FS('write', inputName, audioData);
                await ffmpeg.run('-i', inputName, '-ar', '16000', '-ac', '1', outputName);
                const wavData = ffmpeg.FS('read', outputName);
                const wavBlob = new Blob([wavData.buffer], { type: 'audio/wav' });
                const wavUrl = URL.createObjectURL(wavBlob);

                const audioPlayer = document.createElement('audio');
                audioPlayer.controls = true;
                audioPlayer.src = wavUrl;

                container.innerHTML = '<strong>Áudio:</strong> Transcrevendo (0%)...';
                onProgress();

                const output = await pipeline(wavBlob, {
                    language: 'portuguese',
                    task: 'transcribe',
                    // Não tem progress_callback direto na inferência, mas o modelo já está carregado
                });

                const transcricao = output.text.trim();
                container.innerHTML = `
                    <strong>Áudio:</strong><br>
                    ${audioPlayer.outerHTML}
                    <div class="transcricao"><strong>Transcrição:</strong> ${transcricao || '(sem fala detectada)'}</div>
                `;
                onProgress();
            } catch (err) {
                container.innerHTML += '<br><em>Erro ao processar áudio.</em>';
                console.error(err);
            } finally {
                try { ffmpeg.FS('unlink', inputName); } catch(e) {}
                try { ffmpeg.FS('unlink', outputName); } catch(e) {}
            }
        }
    </script>
</body>
</html>